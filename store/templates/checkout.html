{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="title" content="Checkout | CASIO">
    <meta name="keywords" content="Magento, Varien, E-commerce">
    <meta name="robots" content="INDEX,FOLLOW">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="{% static 'store/USimages/favicon_2.png' %}">
    <link rel="stylesheet" href="{% static 'store/css/registerEmail.css' %}">
    <link rel="stylesheet" href="{% static 'store/css/media.css' %}">
<!--     <script defer src="{% static 'store/scripts/Data.js' %}" ></script>-->
<!--     <script defer src="{% static 'store/scripts/cart2.js' %}" ></script>-->
    <title>{% trans 'Checkout' %} _ CASIO</title>
</head>
<style>
    @media screen and (max-width: 766px){
        .grid-container {
        display: grid;
        grid-template-columns: repeat(1,100%);
        gap: 34px;
        padding: 15px 12px;
        max-width: 100%;
      }
      .formGroup {
    position: relative;
    width: 100%;
    }
    select, input {
    font-size: 80%;
    padding: 1rem 1rem;
    }
    .casio-id-btn.register-btn {
    width: 100%;
    margin-left: 0;
    padding: 14px 2px;
    }
    }
</style>
<body>
    <header>
        <div class="navs">
            <div class="logo">
                <a href="{% url 'main' %}">
                    <img src="{% static 'store/USimages/edifice-logo.jpg' %}" alt="edifice">
                </a>
            </div>
            <div class="cart">
                <div class="bag-number">
                    <a href="{% url 'cart' %}">
                    <img src="{% static 'store/USimages/bag.svg' %}" alt="">
                    <span class="notification">{{ cartItems }}</span></a>
                </div>
            </div>
        </div>
        <main>
            <div class="progress-bar">
                    <div class="stoke">
                       <img src="{% static 'store/USimages/progressbar.jpg' %}" alt="">
                    </div>
            </div>
            <div class="continue-mandatory">
               <a href="{% url 'us' %}"> <p class="continue">&lt; {% blocktrans %}Continue Shopping{% endblocktrans %}</p></a>
                <p class="mandatory">* {% blocktrans %}Mandatory Field{% endblocktrans %}</p>
            </div>
            <div class="grid-container">
                    <div class="content" id="method-content">
                        <div class="method">1. {%blocktrans%}Purchase Method{% endblocktrans%}</div>
                        <div class="method-id-buttons">
                            <div class="id" id="use-casio-id">
                                <span>{% blocktrans %}Use CASIO ID Account{% endblocktrans%}</span>
                                <P class="text">{% blocktrans %}Log in or create a CASIO ID account to easily manage and track your order. An account is required for Tax Exempt orders.{% endblocktrans %}</P>
                            </div>
                            <div class="line" id="casio-id-btns">
                                <div class="buttons">
                                    <button><a href="{% url 'login' %}"> {% blocktrans %}LOG IN{% endblocktrans %}</a></button>
                                    <button><a href="{% url 'register' %}"></a>{% blocktrans %}JOIN US{% endblocktrans %}</button></a>
                                 </div>
                            </div>
                        </div>
                        <div class="guest-input-buttons">
                            <div class="guest">
                                <b>{% blocktrans %} Continue as guest {% endblocktrans%}</b>
                            </div>
                            <form action="" method="POST" class="input" id="registrationForm">
                                {% csrf_token %}
                                <div class="formGroup">
                                    <label for="">{% blocktrans %}Email Address{% endblocktrans %}*</label>
                                    <input required pattern="^(.+)@(.+)$" type="email" name="guest-email">

                                    <span class="check" style="visibility: hidden;">
                                        <i class="fa-solid fa-check"></i>
                                    </span>
                                    <span class="xmark" style="visibility: hidden;">
                                        <i class="fa-solid fa-xmark"></i>
                                    </span>

                                    <div class="error">
                                    </div>
                                </div>
                                <button type="submit" class="casio-id-btn  register-btn">{% blocktrans %}CONTINUE AS GUEST {% endblocktrans %}</button>
                            </form>

                        </div>
                    </div>
                    <div class="sidebar height">
                        <div class="general-style sum-edit">
                            <span class="summary">{% blocktrans %}Order Summary{% endblocktrans%}</span>
                            <span class="edit"><a href="{% url 'cart' %}"><u> {% trans 'Edit' %}</u></a></span>
                        </div>
                        {% for item in items %}
                        <div class="image-code-price">
                            <div class="image">
                                <img src="{% static 'store/USimages/watch1.png' %}" alt="watch-id" width="60" >
                            </div>
                            <div class="code-quantiy">
                                <div class="code">{{ item.product.model }}</div>
                                <div class="quantity">Quantity: {{ item.quantity }}</div>
                            </div>
                            <div class="price">${{ item.product.price|floatformat:2 }}</div>
                        </div>
                        {% endfor %}
                        <div class="general-style  amount">{% blocktrans %}Order Amount{% endblocktrans %}</div>
                        <div class="total-shipping-tax">
                            <div class="total">
                                <span>{% blocktrans %}Cart Subtotal{% endblocktrans%}</span>
                                <span id="sub-total-price">${{ order.total_amount|floatformat:2 }}</span>
                            </div>
                            <div class="total">
                                <span>{% trans 'Shipping' %}</span>
                                <span id="shipping">$0.00</span>
                            </div>
                            <div class="total">
                                <span>{% trans 'Tax' %}</span>
                                <span id="tax">$0.00</span>
                            </div>
                        </div>
                        <div class="general-style" id="estimatedTotal">
                            <span id="est-total">{% blocktrans%}Estimated Total{% endblocktrans %}</span>
                            <span class="estimated-total" >$ {{ order.total_amount|floatformat:2 }}</span>
                        </div>
                    </div>
            </div>
            <div class="shippinginfo-payment">
                <div class="shippinginfo bg-border">
                    <p>2. {% blocktrans%}Shipping Information{% endblocktrans%}</p>
                </div>
                <div class="payment bg-border">
                    <p>3. {% trans 'Payment' %}</p>
                </div>
            </div>
        </main>
    </header>
    <footer>
        <div class="privacy-terms-cookies">
            <span>{% blocktrans %}Privacy Policy{% endblocktrans %}</span>
            <span>{% blocktrans %}Terms of Sale{% endblocktrans %}</span>
            <span>{% blocktrans %}Cookie Policy{% endblocktrans %}</span>
        </div>
        <div class="copyrights">
            <p>Â© 2022 CASIO AMERICA, INC.</p>
        </div>
    </footer>
    <script src="{% static 'store/scripts/registerEmail.js' %}" ></script>
</body>
    <script type="text/javascript">
        var user = '{{ request.user }}'

        console.log(user)

        function getToken(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== ''){
                var cookies = document.cookie.split(';');
                for (var i=0; i<cookies.length; i++){
                    var cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want ?
                    if (cookie.substring(0, name.length + 1) === (name + '=')){
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getToken('csrftoken');

        function getCookie(name){
            // split cookie strings and get individual name=values pairs in an array
            var cookieArr = document.cookie.split(";");

            // Loop through the array elements
            for (var i=0; i < cookieArr.length; i++){
                var cookiePair = cookieArr[i].split("=");

                // Removing whitespaces at the beginning of the cookie name
                // and compare it with the given string
                if (name == cookiePair[0].trim()){
                    // Decode the cookie value and return
                    return decodeURIComponent(cookiePair[1]);
                }

            }
            // Return null if not found
            return null;
        }
        var cart = JSON.parse(getCookie('cart'))

        if (cart == undefined){
            cart = {}
            console.log('Cart Created!', cart)
            document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/"
        }
        console.log('cart:', cart)

        var total = '{{order.total_amount|floatformat:2}}'

        if (user != 'AnonymousUser'){
            document.getElementById('method-content').innerHTML = ""
        }
        if (shipping == 'False' && user != 'AnonymousUser'){
            //Hide the entire form if user is logged in and shipping is false
            document.getElementById('sh-address').classList.add("hidden");
            //Show payment if logged in user wants to buy an item that does not require shipping
            document.getElementById('pmt-method').classList.remove("hidden");
        }

        var form = document.getElementById('form')
        var casioID = document.getElementById('use-casio-id')
        var casioIDBtns = document.getElementById('casio-id-btns')
        var guestBtns = document.getElementById('guest-input-buttons')


        form.addEventListener('submit', function(e){
            e.preventDefault()
            console.log('Form Submitted...')
            casioID.style.display = 'none';
            casioIDBtns.style.display = 'none';
            guestBtns.style.display = 'none';
        })

        document.getElementById('make-payment').addEventListener('click', function(e){
            submitFormData()
        })

        function submitFormData(){
            console.log('Payment button clicked')

            var userFormData = {
            'name': null,
            'email': null,
            'total': total,
        }

            var shippingInfo = {
            'address': null,
            'city': null,
            'state': null,
            'zipcode': null,
            }

            if(shipping != 'False'){
            shippingInfo.address = form.address.value
            shippingInfo.city = form.city.value
            shippingInfo.state = form.state.value
            shippingInfo.zipcode = form.zipcode.value
            }
            if(user == 'AnonymousUser'){
            userFormData.name = form.name.value
            userFormData.email = form.email.value
            }


            var url = '/process_order/'
            fetch(url, {
            method: 'POST',
            header: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            },
            bode:JSON.stringify({'form': userFormData, 'shipping': shippingInfo})
            })
            .then((response) =>response.json())
            .then((data) =>{
                console.log('Success:', data);
                alert('Transaction Completed');

                cart = {}
                document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/"

                window.location.href = "{% url 'main' %}"
            })
        }
    </script>
</html>